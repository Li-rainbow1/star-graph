# æ˜Ÿå›¾é¡¹ç›® - æ–‡ç”Ÿå›¾å®Œæ•´æµç¨‹è¯¦è§£

> **æ–‡æ¡£è¯´æ˜ï¼š** æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£æ˜Ÿå›¾AIé¡¹ç›®ä¸­"æ–‡ç”Ÿå›¾"åŠŸèƒ½çš„å®Œæ•´ä¸šåŠ¡æµç¨‹å’ŒæŠ€æœ¯å®ç°ã€‚

---

## ğŸ“‘ ç›®å½•

1. [æµç¨‹æ¦‚è¿°](#æµç¨‹æ¦‚è¿°)
2. [Stable DiffusionåŸç†](#stable-diffusionåŸç†)
3. [ComfyUIå·¥ä½œæµ](#comfyuiå·¥ä½œæµ)
4. [å®Œæ•´ä¸šåŠ¡æµç¨‹10æ­¥](#å®Œæ•´ä¸šåŠ¡æµç¨‹10æ­¥)
5. [æŠ€æœ¯æ¶æ„å›¾](#æŠ€æœ¯æ¶æ„å›¾)
6. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)

---

## æµç¨‹æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ–‡ç”Ÿå›¾ï¼Ÿ

**æ–‡ç”Ÿå›¾ï¼ˆText-to-Imageï¼‰** = ç”¨æˆ·è¾“å…¥æ–‡å­—æè¿° â†’ AIç”Ÿæˆå¯¹åº”å›¾ç‰‡

**ç¤ºä¾‹ï¼š**
- è¾“å…¥ï¼š"ç¾å¥³ï¼Œæ²™æ»©ï¼Œå¤ªé˜³ä¼"
- è¾“å‡ºï¼šç¬¦åˆæè¿°çš„é«˜è´¨é‡å›¾ç‰‡

### æ•´ä½“æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ å‚æ•°å¤„ç† â†’ ä¸­è¯‘è‹± â†’ ç”Ÿæˆå·¥ä½œæµJSON 
â†’ å­˜å…¥Redisé˜Ÿåˆ— â†’ å®šæ—¶è°ƒåº¦ â†’ å‘é€ComfyUI 
â†’ ç›‘å¬è¿›åº¦ â†’ ä¿å­˜ç»“æœ â†’ æ¨é€å‰ç«¯
```

---

## Stable DiffusionåŸç†

### æ ¸å¿ƒæ€æƒ³

SDç”Ÿæˆå›¾ç‰‡çš„æ ¸å¿ƒï¼š**ä»å™ªå£°å›¾é€æ­¥å»å™ªï¼Œç”Ÿæˆæ¸…æ™°å›¾ç‰‡**

1. ç”Ÿæˆéšæœºå™ªå£°å›¾ï¼ˆé©¬èµ›å…‹ï¼‰
2. æ ¹æ®æç¤ºè¯é€æ­¥å»é™¤å™ªå£°
3. å¾—åˆ°ä¸æ–‡æœ¬åŒ¹é…çš„å›¾ç‰‡

### ä¸‰å¤§ç»„æˆéƒ¨åˆ†

#### 1. è¾“å…¥ç¼–ç å™¨ï¼ˆCLIP Textï¼‰
- ä½œç”¨ï¼šæ–‡æœ¬ â†’ è¯­ä¹‰å‘é‡
- ç‰¹ç‚¹ï¼šåªæ¥å—è‹±æ–‡ï¼Œæœ€å¤š77ä¸ªtoken
- è¾“å‡ºï¼š77Ã—768çš„å‘é‡

#### 2. å›¾ç‰‡ç”Ÿæˆå™¨ï¼ˆUNet + Schedulerï¼‰
- ä½œç”¨ï¼šåœ¨æ½œç©ºé—´ç”Ÿæˆå›¾ç‰‡
- è¿‡ç¨‹ï¼šè¿­ä»£å»å™ªï¼Œæå‡è´¨é‡
- å‚æ•°ï¼šstepsæ§åˆ¶è¿­ä»£æ¬¡æ•°

#### 3. å›¾ç‰‡è§£ç å™¨ï¼ˆVAE Decoderï¼‰
- ä½œç”¨ï¼šæ½œç©ºé—´ â†’ åƒç´ ç©ºé—´
- è½¬æ¢ï¼š64Ã—64Ã—4 â†’ 512Ã—512Ã—3
- ä¼˜åŠ¿ï¼šå‡å°‘48å€è®¡ç®—é‡

---

## ComfyUIå·¥ä½œæµ

### æ ¸å¿ƒèŠ‚ç‚¹

**1. CheckpointåŠ è½½å™¨** - åŠ è½½SDå¤§æ¨¡å‹

**2. CLIPæ–‡æœ¬ç¼–ç å™¨ï¼ˆæ­£å‘ï¼‰** - æ­£å‘æç¤ºè¯è½¬å‘é‡

**3. CLIPæ–‡æœ¬ç¼–ç å™¨ï¼ˆè´Ÿå‘ï¼‰** - è´Ÿå‘æç¤ºè¯è½¬å‘é‡

**4. ç©ºLatent** - åˆ›å»ºåˆå§‹æ½œç©ºé—´

**5. Ké‡‡æ ·å™¨** - æ ¸å¿ƒç”Ÿå›¾ï¼Œè¿­ä»£å»å™ª

**6. VAEè§£ç ** - æ½œç©ºé—´è½¬åƒç´ ç©ºé—´

**7. ä¿å­˜å›¾åƒ** - ä¿å­˜åˆ°ç£ç›˜

### å·¥ä½œæµJSONç¤ºä¾‹

```json
{
  "3": {
    "inputs": {
      "seed": 1097720578524313,
      "steps": 20,
      "cfg": 8,
      "sampler_name": "euler",
      "scheduler": "normal",
      "model": ["4", 0],
      "positive": ["6", 0],
      "negative": ["7", 0],
      "latent_image": ["5", 0]
    },
    "class_type": "KSampler"
  }
}
```

---

## å®Œæ•´ä¸šåŠ¡æµç¨‹10æ­¥

### ç¬¬1æ­¥ï¼šç”¨æˆ·æäº¤ä»»åŠ¡

**å‰ç«¯æ“ä½œï¼š**
1. è¾“å…¥æç¤ºè¯ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
2. è®¾ç½®å‚æ•°ï¼šæ•°é‡ã€å°ºå¯¸ã€æ­¥æ•°ã€CFGã€é‡‡æ ·å™¨ç­‰
3. ç‚¹å‡»"å‘é€"æŒ‰é’®

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "propmt": "ç¾å¥³ï¼Œæ²™æ»©ï¼Œå¤ªé˜³ä¼",
  "reverse": "æ¨¡ç³Šï¼Œä½è´¨é‡",
  "size": 2,
  "scale": "512x768",
  "step": 20,
  "cfg": 8,
  "sampler": "euler_normal",
  "model": "majicmixRealistic_v7",
  "seed": 0,
  "clientId": "user-client-123"
}
```

---

### ç¬¬2æ­¥ï¼šå‚æ•°æ ¡éªŒä¸ç§¯åˆ†å†»ç»“

**Controllerå¤„ç†ï¼š**

```java
@PostMapping("/text2image")
public Result propmt(@RequestBody Text2ImageResDto dto) {
    // 1. å‚æ•°æ ¡éªŒ
    if (dto.getPropmt() == null) {
        throw new CustomException("æç¤ºè¯ä¸èƒ½ä¸ºç©º");
    }
    
    // 2. æ£€æŸ¥ä½™é¢
    Long userId = UserUtils.getUser().getId();
    if (balance < dto.getSize() * 10) {
        throw new CustomException("ç§¯åˆ†ä¸è¶³");
    }
    
    // 3. å†»ç»“ç§¯åˆ†ï¼ˆæ¯å¼ 10ç§¯åˆ†ï¼‰
    userFundRecordService.freeze(userId, dto.getSize() * 10);
    
    // 4. è°ƒç”¨Service
    Text2ImageReqDto result = text2ImageService.propmt(dto);
    return Result.success(result);
}
```

**ç§¯åˆ†çŠ¶æ€æœºï¼š**
```
æäº¤ â†’ å†»ç»“
æˆåŠŸ â†’ æ‰£é™¤
å¤±è´¥ â†’ å½’è¿˜
```

---

### ç¬¬3æ­¥ï¼šä¸­æ–‡æç¤ºè¯ç¿»è¯‘

**ä¸ºä»€ä¹ˆç¿»è¯‘ï¼Ÿ**
- SDçš„CLIPæ¨¡å‹ä½¿ç”¨è‹±æ–‡è®­ç»ƒ
- åªæ¥å—è‹±æ–‡è¾“å…¥

**ä½¿ç”¨Ollamaç¿»è¯‘ï¼š**

```java
public String translate(String chinese) {
    OllamaRequest request = new OllamaRequest();
    request.setModel("qwen2.5:0.5b");
    request.setPrompt("ç¿»è¯‘æˆè‹±æ–‡ï¼š" + chinese);
    
    Response<OllamaResponse> response = ollamaApi.generate(request).execute();
    return response.body().getResponse();
}
```

**è‡ªåŠ¨å¢å¼ºï¼š**
- æ­£å‘è¯ï¼š`(8k, best quality, masterpiece), {ç¿»è¯‘ç»“æœ}`
- è´Ÿå‘è¯ï¼š`{ç¿»è¯‘ç»“æœ}, bad face, bad finger, bad arm, bad leg`

---

### ç¬¬4æ­¥ï¼šç”ŸæˆComfyUIå·¥ä½œæµJSON

**ä½¿ç”¨Freemarkeræ¨¡æ¿å¼•æ“ï¼š**

**æ¨¡æ¿ï¼ˆt2i.ftlhï¼‰ï¼š**
```json
{
  "3": {
    "inputs": {
      "seed": ${config.seed},
      "steps": ${config.step},
      "cfg": ${config.cfg},
      "sampler_name": "${config.samplerName}",
      "model": ["4", 0],
      "positive": ["6", 0],
      "negative": ["7", 0]
    }
  },
  "6": {
    "inputs": {
      "text": "${config.propmt}",
      "clip": ["4", 1]
    }
  }
}
```

**Serviceå®ç°ï¼š**
```java
public String renderText2Image(ComfyuiModel model) {
    Template template = configuration.getTemplate("t2i.ftlh");
    StringWriter writer = new StringWriter();
    template.process(Map.of("config", model), writer);
    return writer.toString();
}
```

---

### ç¬¬5æ­¥ï¼šå°è£…ComfyUIä»»åŠ¡

**å¯¹è±¡è½¬æ¢ï¼š**
```
Text2ImageResDto â†’ ComfyuiModel â†’ å·¥ä½œæµJSON 
â†’ ComfyuiRequestDto â†’ ComfyuiTask
```

**ComfyuiTaskç»“æ„ï¼š**
```java
public class ComfyuiTask {
    private String id;           // UUID
    private String clientId;     // å‰ç«¯å®¢æˆ·ç«¯ID
    private Long index;          // é˜Ÿåˆ—åºå·
    private String promptId;     // ComfyUIè¿”å›çš„ID
    private ComfyuiRequestDto comfyuiRequestDto;
    private Long userId;
    private Integer pointCost;   // ç§¯åˆ†æ¶ˆè€—
}
```

---

### ç¬¬6æ­¥ï¼šå­˜å‚¨ä»»åŠ¡åˆ°Redisé˜Ÿåˆ—

**Rediså­˜å‚¨ç»“æ„ï¼š**

```
1. åˆ†å¸ƒå¼ID: DISTRIBUTED_ID (è‡ªå¢)
2. ä»»åŠ¡é˜Ÿåˆ—: DISTRIBUTED_QUEUE (ZSet)
   - Member: ä»»åŠ¡ID
   - Score: é˜Ÿåˆ—åºå·
3. ä»»åŠ¡è¯¦æƒ…: task_{ä»»åŠ¡ID} (String)
   - Value: ComfyuiTaskçš„JSON
```

**å­˜å‚¨ä»£ç ï¼š**
```java
public ComfyuiTask addQueueTask(ComfyuiTask task) {
    // 1. è·å–é˜Ÿåˆ—åºå·
    Long idx = stringRedisTemplate.opsForValue().increment("DISTRIBUTED_ID");
    task.setIndex(idx);
    
    // 2. å­˜å‚¨ä»»åŠ¡è¯¦æƒ…
    stringRedisTemplate.opsForValue().set(
        "task_" + task.getId(),
        JSON.toJSONString(task)
    );
    
    // 3. åŠ å…¥é˜Ÿåˆ—
    stringRedisTemplate.opsForZSet().add(
        "DISTRIBUTED_QUEUE",
        task.getId(),
        idx.doubleValue()
    );
    
    return task;
}
```

**å“åº”å‰ç«¯ï¼š**
```json
{
  "pid": "a1b2c3-...",
  "queueIndex": 5
}
```

---

### ç¬¬7æ­¥ï¼šå®šæ—¶ä»»åŠ¡è°ƒåº¦

**SpringTaskæ¯ç§’æ‰«æï¼š**

```java
@Component
public class RunTaskJob {
    
    @Scheduled(cron = "*/1 * * * * ?")
    public void task() {
        // 1. ä»é˜Ÿåˆ—å–ä»»åŠ¡
        ComfyuiTask task = redisService.popQueueTask();
        if (task == null) return;
        
        // 2. å‘é€ç»™ComfyUI
        Call<HashMap> call = comfyuiApi.addQueueTask(task.getComfyuiRequestDto());
        Response<HashMap> response = call.execute();
        
        if (response.isSuccessful()) {
            String promptId = response.body().get("prompt_id").toString();
            log.info("ä»»åŠ¡æäº¤æˆåŠŸï¼š{}", promptId);
        }
    }
}
```

**å–ä»»åŠ¡ä»£ç ï¼š**
```java
public ComfyuiTask popQueueTask() {
    // å¼¹å‡ºscoreæœ€å°çš„ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    TypedTuple<String> tuple = 
        stringRedisTemplate.opsForZSet().popMin("DISTRIBUTED_QUEUE");
    
    if (tuple == null) return null;
    
    // è·å–ä»»åŠ¡è¯¦æƒ…
    String json = stringRedisTemplate.opsForValue()
        .getAndDelete("task_" + tuple.getValue());
    
    return JSON.parseObject(json, ComfyuiTask.class);
}
```

---

### ç¬¬8æ­¥ï¼šComfyUIæ‰§è¡Œç”Ÿå›¾

**ComfyUIæ”¶åˆ°ä»»åŠ¡åï¼š**

1. âœ… åŠ è½½æ¨¡å‹
2. âœ… CLIPç¼–ç æç¤ºè¯
3. âœ… åˆ›å»ºå™ªå£°Latent
4. âœ… Ké‡‡æ ·å™¨è¿­ä»£å»å™ªï¼ˆ20æ­¥ï¼‰
5. âœ… VAEè§£ç 
6. âœ… ä¿å­˜å›¾ç‰‡

**æ‰§è¡Œæ—¶é—´ï¼š**
- GPUï¼š30ç§’-2åˆ†é’Ÿ
- CPUï¼š5-10åˆ†é’Ÿ

---

### ç¬¬9æ­¥ï¼šWebSocketæ¥æ”¶è¿›åº¦

**åç«¯è¿æ¥ComfyUIçš„WebSocketï¼š**

```java
@Bean
public WebSocketConnectionManager manager(Handler handler) {
    String url = "ws://192.168.100.129:8188/ws?clientId=star-graph";
    WebSocketConnectionManager mgr = 
        new WebSocketConnectionManager(client, handler, url);
    mgr.start();
    return mgr;
}
```

**å¤„ç†æ¶ˆæ¯ï¼š**
```java
@Component
public class ComfyuiMessageHandler extends TextWebSocketHandler {
    
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage msg) {
        JSONObject json = JSON.parseObject(msg.getPayload());
        String type = json.getString("type");
        
        switch (type) {
            case "progress":     // è¿›åº¦æ›´æ–°
                handleProgress(json.getJSONObject("data"));
                break;
            case "executed":     // ç”Ÿæˆå®Œæˆ
                handleExecuted(json.getJSONObject("data"));
                break;
            case "execution_error":  // æ‰§è¡Œå¤±è´¥
                handleError(json.getJSONObject("data"));
                break;
        }
    }
}
```

**ComfyUIæ¨é€çš„æ¶ˆæ¯ï¼š**

**progressæ¶ˆæ¯ï¼š**
```json
{
  "type": "progress",
  "data": {
    "value": 5,
    "max": 20,
    "prompt_id": "abc123"
  }
}
```

**executedæ¶ˆæ¯ï¼š**
```json
{
  "type": "executed",
  "data": {
    "output": {
      "images": [
        {"filename": "ComfyUI_00239_.png", "type": "output"}
      ]
    },
    "prompt_id": "abc123"
  }
}
```

---

### ç¬¬10æ­¥ï¼šä¿å­˜ç»“æœå¹¶æ¨é€å‰ç«¯

**å¤„ç†executedæ¶ˆæ¯ï¼š**

```java
private void handleExecuted(JSONObject data) {
    // 1. è§£æå›¾ç‰‡ä¿¡æ¯
    JSONArray images = data.getJSONObject("output")
                           .getJSONArray("images");
    List<String> urls = new ArrayList<>();
    
    for (int i = 0; i < images.size(); i++) {
        JSONObject img = images.getJSONObject(i);
        String filename = img.getString("filename");
        String url = buildImageUrl(filename);
        urls.add(url);
    }
    
    // 2. ä¿å­˜åˆ°æ•°æ®åº“
    Long userId = task.getUserId();
    userResultService.saveList(urls, userId);
    
    // 3. æ‰£é™¤ç§¯åˆ†
    userFundRecordService.deduct(userId, urls.size() * 10);
    
    // 4. æ¨é€ç»™å‰ç«¯
    simpMessagingTemplate.convertAndSendToUser(
        task.getClientId(),
        "/topic/result",
        new ResultMessage(urls)
    );
}
```

---

## æŠ€æœ¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ç”¨æˆ·    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP/WebSocket
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Spring Boot åç«¯            â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Controllerâ”‚  â”‚ WebSocket  â”‚ â”‚
â”‚  â”‚          â”‚  â”‚   æœåŠ¡ç«¯   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚              â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      Service å±‚          â”‚ â”‚
â”‚  â”‚  - å‚æ•°å¤„ç†              â”‚ â”‚
â”‚  â”‚  - ç¿»è¯‘(Ollama)         â”‚ â”‚
â”‚  â”‚  - é˜Ÿåˆ—ç®¡ç†(Redis)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚            â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚å®šæ—¶ä»»åŠ¡    â”‚ â”‚ WebSocket â”‚ â”‚
â”‚  â”‚(è°ƒåº¦å™¨)    â”‚ â”‚  å®¢æˆ·ç«¯   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Redis   â”‚ â”‚  ComfyUI  â”‚
  â”‚   é˜Ÿåˆ—    â”‚ â”‚  (AIå¼•æ“) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
  â”‚   MySQL   â”‚ â”‚  Ollama   â”‚
  â”‚   æ•°æ®åº“  â”‚ â”‚ (ç¿»è¯‘AI)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. Redis ZSetå®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—

**ä¼˜åŠ¿ï¼š**
- è‡ªåŠ¨æŒ‰scoreæ’åº
- O(log N)æ—¶é—´å¤æ‚åº¦
- æ”¯æŒåŠ¨æ€è°ƒæ•´ä¼˜å…ˆçº§ï¼ˆæ’é˜Ÿï¼‰

**æ“ä½œï¼š**
```java
// å…¥é˜Ÿ
zadd DISTRIBUTED_QUEUE 5 "task-123"

// å‡ºé˜Ÿï¼ˆè·å–æœ€å°scoreï¼‰
zpopmin DISTRIBUTED_QUEUE

// æŸ¥è¯¢æ’å
zrank DISTRIBUTED_QUEUE "task-123"

// æ’é˜Ÿï¼ˆå‡å°scoreï¼‰
zadd DISTRIBUTED_QUEUE 2 "task-123"
```

### 2. Freemarkeræ¨¡æ¿å¼•æ“

**ä½œç”¨ï¼š** åŠ¨æ€ç”ŸæˆComfyUIå·¥ä½œæµJSON

**ä¼˜åŠ¿ï¼š**
- æ¨¡æ¿ä¸ä»£ç åˆ†ç¦»
- æ”¯æŒæ¡ä»¶ã€å¾ªç¯ç­‰é€»è¾‘
- æ˜“äºç»´æŠ¤å’Œä¿®æ”¹

### 3. WebSocketåŒå‘é€šä¿¡

**ä¸¤ä¸ªWebSocketè¿æ¥ï¼š**

**è¿æ¥1ï¼šåç«¯ â†’ ComfyUI**
- è§’è‰²ï¼šå®¢æˆ·ç«¯
- ç”¨é€”ï¼šæ¥æ”¶AIç”Ÿå›¾è¿›åº¦

**è¿æ¥2ï¼šå‰ç«¯ â†’ åç«¯**
- è§’è‰²ï¼šæœåŠ¡ç«¯ï¼ˆSTOMPåè®®ï¼‰
- ç”¨é€”ï¼šæ¨é€è¿›åº¦ç»™å‰ç«¯

**æ¶ˆæ¯æµè½¬ï¼š**
```
ComfyUI â†’ [WSå®¢æˆ·ç«¯] â†’ Spring Boot â†’ [WSæœåŠ¡ç«¯] â†’ å‰ç«¯
```

### 4. åˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰

**è§£å†³é—®é¢˜ï¼š** é›†ç¾¤ç¯å¢ƒä¸‹å®šæ—¶ä»»åŠ¡é‡å¤æ‰§è¡Œ

**å®ç°ï¼š**
```java
RLock lock = redissonClient.getLock("task_scheduler_lock");
try {
    if (lock.tryLock()) {
        // æ‰§è¡Œä»»åŠ¡è°ƒåº¦
        addTaskToQueue();
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
```

### 5. @Transactionaläº‹åŠ¡ç®¡ç†

**ä¿è¯ç§¯åˆ†æ“ä½œåŸå­æ€§ï¼š**

```java
@Transactional
public void saveList(List<String> urls, Long userId) {
    // 1. ä¿å­˜å›¾ç‰‡è®°å½•
    userResultMapper.insertBatch(urls, userId);
    
    // 2. æ‰£é™¤ç§¯åˆ†
    userFundRecordService.deduct(userId, urls.size() * 10);
    
    // ä¸¤æ­¥è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å›æ»š
}
```

---

## æ€»ç»“

### å®Œæ•´æµç¨‹å›é¡¾

1. âœ… **ç”¨æˆ·æäº¤** - å‰ç«¯å‘é€è¯·æ±‚
2. âœ… **å‚æ•°æ ¡éªŒ** - æ£€æŸ¥å‚æ•°å’Œä½™é¢
3. âœ… **ç§¯åˆ†å†»ç»“** - é¢„æ‰£ç§¯åˆ†é˜²æ­¢åˆ·é‡
4. âœ… **ä¸­è¯‘è‹±** - Ollamaç¿»è¯‘æç¤ºè¯
5. âœ… **ç”ŸæˆJSON** - FreemarkeråŠ¨æ€æ¸²æŸ“
6. âœ… **å…¥é˜Ÿ** - å­˜å…¥Redisä¼˜å…ˆçº§é˜Ÿåˆ—
7. âœ… **è°ƒåº¦** - å®šæ—¶ä»»åŠ¡æ‰«æé˜Ÿåˆ—
8. âœ… **å‘é€** - æäº¤ç»™ComfyUIæ‰§è¡Œ
9. âœ… **ç›‘å¬** - WebSocketæ¥æ”¶è¿›åº¦
10. âœ… **ä¿å­˜æ¨é€** - ç»“æœå…¥åº“å¹¶æ¨é€å‰ç«¯

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶ï¼š** Spring Boot 3
- **æ•°æ®åº“ï¼š** MySQL + MyBatis Plus
- **ç¼“å­˜é˜Ÿåˆ—ï¼š** Redis + Redisson
- **HTTPå®¢æˆ·ç«¯ï¼š** Retrofit
- **æ¨¡æ¿å¼•æ“ï¼š** Freemarker
- **å®æ—¶é€šä¿¡ï¼š** WebSocket + STOMP
- **AIå¼•æ“ï¼š** ComfyUI + Stable Diffusion
- **ç¿»è¯‘AIï¼š** Ollama (qwen2.5)

### è®¾è®¡äº®ç‚¹

1. **ä¼˜å…ˆçº§é˜Ÿåˆ—** - Redis ZSetå®ç°ï¼Œæ”¯æŒæ’é˜Ÿ
2. **åŒå‘WebSocket** - æ—¢æ˜¯å®¢æˆ·ç«¯åˆæ˜¯æœåŠ¡ç«¯
3. **åˆ†å¸ƒå¼é”** - è§£å†³é›†ç¾¤å¹¶å‘é—®é¢˜
4. **ç§¯åˆ†çŠ¶æ€æœº** - å†»ç»“â†’æ‰£é™¤/å½’è¿˜
5. **æ¨¡æ¿åŒ–å·¥ä½œæµ** - æ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

**æ–‡æ¡£å®Œæˆæ—¶é—´ï¼š** 2025å¹´10æœˆ25æ—¥  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** æ˜Ÿå›¾AIé¡¹ç›® v1.0
